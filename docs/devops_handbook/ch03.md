# 第三部分 第一步：流动的技术实践

## 1 按需搭建开发环境、测试环境和生产环境

- 类生产环境：开发人员最好能按需或自己创建工作站，并在其上运行类生产环境
- 建立通用的自动化构建机制：任何人都可以在几分钟内搭建类生产环境，不需要提交申请单
    1. 复制虚拟化环境（如VMware虚拟机镜像、执行Vagrant脚本、以及启动Amazon EC2虚拟机镜像文件）
    2. 构建“裸金属物理机”的自动化环境搭建流程
    3. 使用“基础设施即代码”的配置管理工具
- 应用统一的代码仓库：使用版本控制系统管理配置项，包括
    1. 应用的所有代码和依赖项
    2. 任何用于创建数据库模式的脚本、应用的参考数据等
    3. 所有用于搭建环境的工具和工件
    4. 任何构建容器所使用的文件
    5. 所有支持自动化测试和手动测试的脚本
    6. 任何支持代码打包、部署、数据库迁移和环境置备的脚本
    7. 所有项目工件（需求文档、部署过程、发布说明等）
    8. 所有云平台配置文件
    9. 创建支持多种基础设施服务
- 确保所有变更都能自动被复制到所有环境中，并被版本控制系统记录，保证一致性。

## 2 实现快速可靠的自动化测试

案例：谷歌Web服务器（GWS）团队通过搭建持续集成流水线，设置测试覆盖率监控指标，编写了测试规范和指南，实现自动化测试。

- 对代码和环境做持续构建、测试和集成：创建自动化测试套件的目的是提高集成频率，使测试从阶段性活动演变成持续性活动。部署流水线以自服务的方式为用户验收测试、集成测试和安全测试提供环境。（开源软件：Jenkins、ThoughWorks GoCD、Conncourse、Bamboo、Microsoft Team Foundation Server、TeamCity和GitLab CI）
- 构建快速可靠的自动化测试套件：尽早地在测试中发现错误
    1. 单元测试：通常独立测试每个方法、类或函数
    2. 验收测试：整体测试应用，确保各个功能模块按照设计正常工作
    3. 集成测试：保证应用能与生产环境中的其他应用和服务正确交互，不再调用打桩的接口
- TDD（测试驱动开发）：红灯-绿灯-重构
- 编写和执行自动化性能测试的目标：验证整个应用栈（代码、数据库、存储、网络、虚拟化等）的性能，将它作为部署流水线的一部分
- 在部署流水线失败时拉下安灯绳：当部署流水线失败时，至少要告知整个团队。当部署流水线的后期阶段失败时，不应停止所有新工作，应让一部分开发人员和测试人员随时待命，他们负责在问题发生时立即解决

## 3 应用和实践持续集成

案例：惠普LaserJet固件部门通过构建统一的代码库，基于主干的开发方式，任何一个固件版本都可以支持所有的型号，打印机的所有功能通过一个XML配置文件来设定。

- 小批量开发与大批量合并：提高个人生产力（所有人都在自己的分支上工作）、提高团队生产力（所有人都在同一个区域里工作，没有分支，只有很长、不可被中断的主干）
- 应用基于主干的开发实践：让每个开发人员每天都至少向主干提交一次代码。配置部署流水线，使用门控提交方式（拒绝接受任何使系统偏离可部署状态的提交）
- “完成”的涵义解释：在每个迭代周期结束时，已经在类生产环境中集成和测试了可工作和可交付的代码，这些代码通过一键式流程在主干上创建，并已通过自动化测试（Bazaarvice的持续集成实践：建立新的业务目标——实现更快速的A/B测试、加快新特性进入生产环境的速度）

## 4 自动化和低风险发布

案例：Facebook的代码发布，开发人员通过加入IRC聊天工具，提交部署包，采用持续集成和低风险的代码部署流程，把代码部署变成所有人的日常工作，要求代码的部署操作是自动化、可重复和可预测的。

- 自动化部署流程：优化并自动化部署流程，构建部署流水线，具备用相同的方式处理所有环境的部署、对部署执行冒烟测试、维持环境的一致性（CSG国际公司的每日部署：建立共享运维团队SOT负责管理所有环境，并执行代码部署工作，并建立一个开发和部署流程，交叉培训开发人员）
- 应用自动化的自助式部署：构建、测试、部署
- 在部署流水线中集成代码部署，需要具备以下能（Etsy持续集成案例-开发人员自助部署）：
    1. 保证在持续集成阶段构建的软件包可以部署到生产环境中
    2. 使生产环境的就绪情况一目了然
    3. 为能在生产环境中部署的任何代码，建立一键式和自助式的发布机制
    4. 自动记录审计和合规管理所需的相关内容
    5. 通过冒烟测试验证系统正常工作
    6. 为开发人员快速提供反馈，使他们能够尽快了解部署结果
- 将部署与发布解耦：
    1. 部署：指在特定的环境中安装指定版本的软件
    2. 发布：指把一个特性（或一组特性）提供给所有客户或者一部分酷虎，特性发布不需要变更应用的代码
- 基于环境的发布模式：在两个或更多的环境中部署系统，当实际上只有一个环境处理客户流量（灾备）。
    1. 蓝绿部署模式：类似于主备切换
    2. 处理数据库变更：创建两个数据库（蓝绿数据库）、将数据库变更与应用变更解耦（Dixons对POS系统进行蓝绿部署，缩短版本切换的时间）
    3. 金丝雀发布模式：监控软件在每个环境中的运行情况，一旦出现问题，就回滚
- 基于应用的发布模式：对应用进行修改，通过细微的配置变更，选择性地发布或开放应用特性。
    1. 实现特性开关：在不进行生产环境代码部署的情况下，选择性地启用和禁用特性，实现机制通常是用条件语句封装应用逻辑或用户界面元素，并根据保存在某处的配置信息启用或禁用某个特性。具有轻松地回滚、缓解性能压力、采用面向服务架构提高恢复能力等优势
    2. 实现黑启动：先把所有特性都部署到生产环境中，然后对客户不可见的特性进行测试。（Facebook聊天功能的黑启动过程，通过特性开关服务Gatekeeper，聊天功能只对团队成员开放，对外部用户完全不可见）
- 持续交付：所有开发人员都在主干上进行小批量工作，或者在短时间存在的特性分支上工作，并定期向主干合并，同时始终让主干保持可发布状态，并能做到在正常的工作时段按需进行一键式发布。开发人员在引入任何回归错误时，都能快速得到反馈。一旦发现这类问题，就立即加以解决，从而保持主干始终处于可部署状态。
- 持续部署：在持续交付的基础上，由开发人员或运维人员自助式地定期向生产环境部署优质的构建版本，通常意味着每天没人至少做一次生产环境部署，甚至每当开发人员提交代码变更时，就触发一次自动化部署。

## 5 降低发布风险的架构

案例：Randy Shoup的团队在eBay使用绞杀者应用模式，将已有功能用API封装起来，避免对它们做变更，然后在使用新架构的新服务中实现所有的新功能，只有在必要的时候才调用旧系统的API。

- 提高生产力、可测试性和安全性的架构：接口定义清晰的松耦合架构，优化了模块间的依赖关系，提高了生产力和安全性，让小型且高产的“双比萨”团队可以执行小的变更，并能安全和独立的进行部署。
- 架构原型：单体架构与微服务（亚马逊的演进式架构：从两层的单体架构转为分布式的去中心化服务平台）
- 安全地演进企业架构：使用绞杀者模式（所有服务都通过版本化API访问），不影响调用者的情况下变更服务，降低系统的耦合度（Blackboard Lean的绞杀者应用模式：逐步构建模块替代单体应用）