# 第四部分 第二步：反馈的技术实践

## 1 建立能发现并解决问题的遥测系统

- 建设集中式监控架构：其组成部分包括在业务逻辑、应用程序和环境层收集数据，负责存储和转发事件和指标的事件路由器。从部署流水线中采集数据，保证能方便地在遥测基础设施中输入和检索信息，监控数据还要适用于手动和自动分析。
- 建立生产环境的应用程序日志遥测：日志级别包括调试级别、信息级别、告警级别、错误级别、致命级别；保证所有潜在的重大应用事件都能生成日志记录条目。
- 使用遥测指导问题的解决：对具体问题的原因和解决方案作出假设
- 将建立生产遥测融入日常工作：建立必要的基础设施和库，让任何开发或运维人员都能很容易地针对任何功能创建遥测。
- 建立自助访问的遥测和信息辐射器：项目团队放置在一个非常显眼位置上的手写、绘制、印刷或电子信息展示，让所有团队成员以及路过的人都可以快速浏览最新信息：自动化测试次数、速率、事故报告、持续集成状态等。（LinkedIn创建自助服务指标：创造了InGraphs，获得所有运行着某个服务的主机的CPU使用率这种简单的信息，只需要填写一份表单，30分钟后可以得到所需的报表）
- 发现和填补遥测的盲区：构建多个层级的度量指标，包括业务级别、应用程序级别、基础架构级别、客户端软件级别、部署流水线级别。通过监控所有应用程序和基础设施的故障，能够更好地识别出和信息安全有关的事件。

## 2 分析遥测数据以更好地预测故障和实现目标

案例：Netflix通过异常检测技术，大大降低了识别故障服务器的成本，缩短了修复时间，提高了服务质量。

- 用均值和标准差识别潜在问题：创建一个过滤器，用来检测度量指标与正常值显著不同的情况，配置告警以便触发修复动作。通过提高信噪比、关注差异值或异常值，建立告警机制。
- 异常状态的处理和告警：分析在近期（例如30天内）遇到的最严重的事故，并建立一个遥测列表，用来更早、更快地检测和诊断问题，以及更方便、更快捷地确认已经实施了有效的修复措施。
- 非高斯分布遥测数据的问题：该类问题会导致告警过度或告警不足。（Netflix的自动扩展能力：通过Scryer解决AAS的自动扩展问题，解决处理需求急剧增长的情况、出现服务终端后的移除计算能力的情况，使用异常检测组合抛出伪数据点，同时保留在其数据中重现的合法流量峰值）
- 应用异常检测技术：使用平滑统计（使用移动平均数，利用每个点与滑动窗口中的所有其他数据的平均值来转换数据）抑制短期波动，突出长期趋势和周期。（高级的异常检测：使用Graphite和Grafana工具，处理异常检测）

## 3 应用反馈实现安全部署

案例：Right Media公司通过同行评审、互相帮助写出更加优质的自动化测试代码，部署流水线能及时提供反馈，让开发人员建立部署代码的信心。

- 通过遥测使部署安全：积极主动地监控生产环境的度量指标，当部署流水线中发现错误时，使用特性开关关闭出错的功能，或者前向修复这个错误，或者回退。
- 开发和运维共同承担值班工作：让价值流中的所有人共同承担处理运维事故的下游责任，让开发人员、开发经理和架构师轮流和运维团队共同值班。
- 让开发人员跟踪工作对下游的影响：使用情境访谈，开发团队观察客户在他们的自然环境中使用应用系统，亲见客户所面临的困难，他们会在日常开发工作中做出更好和更明智的决策。
- 让开发人员自行管理生产服务：通过建立服务发布指南，确保用整个组织的集体智慧帮助每个产品开发团队。服务发布指南和要求可能包含的内容有：缺陷计数和严重性、告警的类型/频率、监控覆盖率、系统架构、部署过程、生产环境的整洁。
- 服务回传机制：当生产环境中的一个服务变得非常脆弱时，运维部门能把支持这个服务的责任交回给开发部门。（谷歌的HRR交接就绪审核和LRR上线就绪审核）

## 4 将假设驱动的开发和A/B测试融入日常工作

案例：Intuit在构建业务和财务管理方面，鼓励团队采用实验的方法进行产品开发，并号召领导层都支持这种做法。TurboTax团队进行了在线用户实验，所需的生产环境变更都变成了低风险活动，使软件的部署与发布变得更快速和安全。

- A/B测试技术：最早在直效营销中率先使用，通过做实验来确定哪种形式的转换率最高。也被称为在线控制实验和拆分测试。
- 在功能测试中集成A/B测试
- 在发布中集成A/B测试：通过勾选特性开关将软件的多个版本同时交付给用户群，进行快速、迭代的A/B测试，控制能看到实验组版本的用户比例
- 在功能规划中集成A/B测试：采用实验的方法进行产品开发，不但需要将工作分解成更小的单元（故事或需求），而且还要验证每个工作单元是否能够实现预期的结果。如果没有达到预期，就用替代方案修改工作路线图，并最终实现业务成果。（快速的发布周期实验使Yahoo!Answers收入翻番：越快地迭代并将反馈集成到向客户提供的产品或服务中，学习的速度就越快，产生的影响也越大。在部署之前还在审核要做的变更，确保没有偏离正轨）

## 5 建立评审和协作流程以提升当前工作的质量

案例：GitHub使用Pull Request的流程，建立同行评审机制，提高代码质量、使部署更安全，并融入每个人的日常工作流程中。

- GitHub Flow的步骤：
    1. 工程师为了实现一项新功能需求，要基于主干建立一个命名清晰的分支。
    2. 工程师提交代码到本地分支，并定期将工作成果推送到远端服务器的同名分支上。
    3. 当他们需要反馈或帮助时，过着准备将这个分支的代码合并到主干时，就会提交一个新的Pull Request。
    4. 在他们获得期望的评审并通过必要的审核后，就可以将代码合并到主干。
    5. 一但将代码变更合并进了主干，工程师就可以将其部署到生产环境了。
- 变更审批流程的危险：避免两种反事实（此次事故是由于变更控制失效导致的、此次事故是由于测试失败导致的）
- ”过度控制变更“的潜在危险：组织越依赖变更审批，在稳定性（平均服务恢复时间和更改失败率）和吞吐量（部署前置时间、部署频率）方面的表现就越差。
- 变更的协调和排程：组织的架构越是松耦合，组建团队之间需要沟通和协调的事情就越少。
- 变更的同行评审：保持小批量尺寸的原则适用于代码评审，代码评审的形式包含结对编程、”肩并肩“、电子邮件评审、工具辅助评审。（谷歌的代码评审：主要涵盖语言的代码可读性、代码分支所有权的分配、在团队中提倡代码的透明度和贡献度）
- 人工测试和变更的潜在危害：批量尺寸越大，变更的成功率就越低，事故发生的数量和平均故障恢复时间（MTTR）也随之上升。
- 利用结对编程改进代码变更：由两名软件开发工程师同时在同一台工作站中工作，有两种模式：
    1. 一名工程师扮演驾驶者角色，另一名扮演导航员、观察者或督导者
    2. 通过测试驱动开发，一名工程师编写自动化测试，另一名工程师编写代码